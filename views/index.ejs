<%- include("partials/header.ejs", { currentPath: 'home' }) %>

<section class="search-hero">
  <h1>植被健康度即時查詢（Super NDVI Researcher）</h1>
  <p>輸入座標與範圍，就能取得最新的 Modis NDVI 熱力圖與平均值，協助你即時掌握植生狀態。</p>
</section>

<form action="/search" method="post" class="search-form">
  <div class="row">
    <div>
      <label for="lat">緯度（lat）</label>
      <input id="lat" name="lat" type="number" step="0.001" value="<%= lat %>" required />
    </div>
    <div>
      <label for="lon">經度（lon）</label>
      <input id="lon" name="lon" type="number" step="0.001" value="<%= lon %>" required />
    </div>
    <div>
      <label for="range">範圍（radius）</label>
      <input id="range" name="range" type="number" step="1" max="1000" value="<%= range %>" required />
    </div>
    <div>
      <label for="unit">單位（unit）</label>
      <select id="unit" name="unit" required>
        <option value="M" <%= unit === "M" ? "selected" : "" %>>公尺（Meter）</option>
        <option value="K" <%= unit === "K" ? "selected" : "" %>>公里（Kilometer）</option>
      </select>
    </div>
  </div>
  <button type="submit" class="search-form__submit">查詢植生狀況（Search NDVI）</button>
  <% if (locals.error) { %><div class="error"><%= error %></div><% } %>
</form>
<% if (locals.image) {
     const ndviAvailable = typeof ndvi_avg !== "undefined" && ndvi_avg !== null && ndvi_avg !== "";
     const unitLabel = unit === "K" ? "公里" : unit === "M" ? "公尺" : unit || "";
  %>
  <section class="result-card">
    <header class="result-card__header">
      <div>
        <h2>分析摘要（analysis）</h2>
        <p>以下為最新 Landsat 影像計算出的 NDVI 指標。</p>
      </div>
      <% if (locals.image_date) { %>
        <span class="result-card__pill">影像日期（Image date） :<strong><%= image_date %></strong></span>
      <% } %>
    </header>

    <div class="result-card__grid">
      <div class="result-card__meta">
        <div class="meta-item">
          <span class="meta-item__label">輸入座標（Input coordinate）</span>
          <span class="meta-item__value"><%= lat || '-' %>, <%= lon || '-' %></span>
        </div>
        <div class="meta-item">
          <span class="meta-item__label">分析範圍（Analyze range）</span>
          <span class="meta-item__value"><%= range || '-' %> <%= unitLabel %></span>
        </div>
        <div class="meta-item">
          <span class="meta-item__label">平均 NDVI（Average NDVI value）</span>
          <span class="meta-item__value">
            <%= ndviAvailable ? Number(ndvi_avg).toFixed(3) : '暫無資料' %>
          </span>
        </div>
      </div>

      <figure class="result-card__image">
        <img src="<%= image %>" alt="NDVI Heatmap" />
        <figcaption>NDVI 熱力圖（NDVI heatmap）</figcaption>
      </figure>
    </div>
  </section>
<% } %>
<%- include("partials/footer.ejs") %>
